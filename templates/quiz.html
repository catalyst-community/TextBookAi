<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/static/images/text-logo.png" />
    <title>Quiz - {{ chapter }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/css/index.css" />
    <style>
      .quiz-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .quiz-title {
        text-align: center;
        margin-bottom: 30px;
      }
      .card {
        margin-bottom: 20px;
      }
      .submit-button-container {
        text-align: center;
        margin-top: 20px;
      }
      .quiz-results {
        text-align: center;
      }
      .feedback {
        text-align: left;
        max-width: 600px;
        margin: 0 auto;
      }
      .loader {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
      }
    </style>
  </head>
  <body>
    <div class="container quiz-container mt-5">
      <h1 class="quiz-title">Quiz for {{ chapter }}</h1>
      <div id="quiz-content">
        <div class="loader">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Loading quiz...</p>
        </div>
      </div>
      <div class="mb-5"></div>
    </div>

    <script>
      let quizQuestions = [];

      async function loadQuiz() {
        const quizContent = document.getElementById("quiz-content");
        try {
          console.log("Fetching quiz for chapter:", "{{ chapter }}");
          const response = await fetch(`/api/quiz/{{ chapter }}`);
          console.log("Response status:", response.status);
          if (response.ok) {
            const data = await response.json();
            console.log("Quiz data:", data);
            if (data.error) {
              quizContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            } else if (data.questions && data.questions.length > 0) {
              quizQuestions = data.questions;
              displayQuiz(quizQuestions);
            } else {
              quizContent.innerHTML = `<div class="alert alert-warning">No quiz questions were generated. Please try again.</div>`;
            }
          } else {
            const errorText = await response.text();
            console.error("Error response:", errorText);
            quizContent.innerHTML = `<div class="alert alert-danger">An error occurred while loading the quiz. Status: ${response.status}</div>`;
          }
        } catch (error) {
          console.error("Error loading quiz:", error);
          quizContent.innerHTML = `<div class="alert alert-danger">An error occurred while loading the quiz: ${error.message}</div>`;
        }
      }

      function displayQuiz(questions) {
        const quizContent = document.getElementById("quiz-content");
        let quizHTML = "";

        questions.forEach((q, index) => {
          quizHTML += `
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">${index + 1}. ${q.question}</h5>
                    ${q.options
                      .map(
                        (option, i) => `
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="q${index}" id="q${index}o${i}" value="${option.charAt(
                          0
                        )}">
                            <label class="form-check-label" for="q${index}o${i}">${option}</label>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            </div>
            `;
        });

        quizHTML += `
          <div class="submit-button-container">
            <button class="btn btn-primary" onclick="submitQuiz()">Submit Quiz</button>
          </div>`;
        quizContent.innerHTML = quizHTML;
      }

      function submitQuiz() {
        console.log("Submit button clicked");
        let score = 0;
        let feedback = "";

        quizQuestions.forEach((q, index) => {
          const selectedAnswer = document.querySelector(
            `input[name="q${index}"]:checked`
          );
          console.log(
            `Question ${index + 1} selected answer:`,
            selectedAnswer ? selectedAnswer.value : "Not answered"
          );

          feedback += `<div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">${index + 1}. ${q.question}</h5>
              <ul class="list-group">`;

          q.options.forEach((option, i) => {
            const isCorrect = option.charAt(0) === q.correct_answer;
            const isSelected =
              selectedAnswer && selectedAnswer.value === option.charAt(0);
            let itemClass = "list-group-item";

            if (isCorrect) {
              itemClass += " list-group-item-success";
            } else if (isSelected && !isCorrect) {
              itemClass += " list-group-item-danger";
            }

            feedback += `<li class="${itemClass}">
              ${option}
              ${
                isCorrect
                  ? ' <span class="badge bg-success">Correct</span>'
                  : ""
              }
              ${
                isSelected && !isCorrect
                  ? ' <span class="badge bg-danger">Your Answer</span>'
                  : ""
              }
            </li>`;
          });

          feedback += `</ul>`;

          if (selectedAnswer) {
            if (selectedAnswer.value === q.correct_answer) {
              score++;
            }
          } else {
            feedback += `<p class="text-warning mt-2">Not answered.</p>`;
          }

          feedback += `</div></div>`;
        });

        const quizContent = document.getElementById("quiz-content");
        quizContent.innerHTML = `
          <div class="quiz-results">
            <h3>Quiz Results</h3>
            <p>Your score: ${score} out of ${quizQuestions.length}</p>
            <div class="feedback">
              ${feedback}
            </div>
            <button class="btn btn-primary mt-3" onclick="window.close()">Close Quiz</button>
          </div>
        `;
      }

      // Load the quiz when the page loads
      window.onload = loadQuiz;
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
